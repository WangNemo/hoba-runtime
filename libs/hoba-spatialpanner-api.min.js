HOBA=window.HOBA||{},HOBA.AudioNode=function(){this.input=null,this.output=null},HOBA.AudioNode.prototype={connect:function(t,e,n){e=e||0,n=n||0,this.output.connect(t,e,n)},disconnect:function(t,e,n){t=t||null,e=e||0,n=n||0,this.output.disconnect(t,e,n)}},Object.defineProperties(HOBA.AudioNode.prototype,{context:{get:function(){return HOBA.audioContext}},numberOfInputs:{get:function(){return 1}},numberOfOutputs:{get:function(){return 1}},channelCount:{get:function(){return 2}},channelCountMode:{get:function(){return"clamped-max"}},channelInterpretation:{get:function(){return"speakers"}}}),HOBA.PannerBase=function(){this.posc={x:0,y:0,z:-1},this.orientc={x:0,y:0,z:0},this._distance=new HOBA.DistanceModel,this._cone=new HOBA.ConeModel},HOBA.PannerBase.prototype=Object.create(HOBA.AudioNode.prototype),Object.defineProperties(HOBA.PannerBase.prototype,{panningModel:{get:function(){return"HRTF"}},positionX:{get:function(){return this.posc.x},set:function(t){this._setPosC("x",t)}},positionY:{get:function(){return this.posc.y},set:function(t){this._setPosC("y",t)}},positionZ:{get:function(){return this.posc.z},set:function(t){this._setPosC("z",t)}},orientationX:{get:function(){return this.orientc.x},set:function(t){this._setOrientC("x",t)}},orientationY:{get:function(){return this.orientc.y},set:function(t){this._setOrientC("y",t)}},orientationZ:{get:function(){return this.orientc.z},set:function(t){this._setOrientC("z",t)}},distanceModel:{get:function(){return this._distance.model},set:function(t){this._setDistance("model",t)}},refDistance:{get:function(){return this._distance.refDistance},set:function(t){this._setDistance("refDistance",t)}},maxDistance:{get:function(){return this._distance.maxDistance},set:function(t){this._setDistance("maxDistance",t)}},rolloffFactor:{get:function(){return this._distance.rolloffFactor},set:function(t){this._setDistance("rolloffFactor",t)}},coneInnerAngle:{get:function(){return this._cone.innerAngle},set:function(t){this._setCone("innerAngle",t)}},coneOuterAngle:{get:function(){return this._cone.outerAngle},set:function(t){this._setCone("outerAngle",t)}},coneOuterGain:{get:function(){return this._cone.outerGain},set:function(t){this._setCone("outerGain",t)}}}),HOBA.PannerBase.prototype.setCPosition=function(t,e,n){return this.posc.x=t,this.posc.y=e,this.posc.z=n,this._update("position")},HOBA.PannerBase.prototype.setOrientation=function(t,e,n){this.orientc.x=t,this.orientc.y=e,this.orientc.z=n,this._update("orientation")},HOBA.PannerBase.prototype._setPosC=function(t,e){this.posc[t]=e,this._update("position")},HOBA.PannerBase.prototype._setOrientC=function(t,e){this.orientc[t]=e,this._update("orientation")},HOBA.PannerBase.prototype._setDistance=function(t,e){this._distance[t]=e,this._update("distance")},HOBA.PannerBase.prototype._setCone=function(t,e){this._cone[t]=e,this._update("cone")},HOBA.PannerBase.prototype._update=function(){},HOBA.DistanceModel=function(){this.model="inverse",this.refDistance=1,this.maxDistance=1e4,this.rolloffFactor=1},HOBA.DistanceModel.prototype={gain:function(t){var e=Math.min(t,this.maxDistance);switch(e=Math.max(e,this.refDistance),this.model){case"linear":return 1-this.rolloffFactor*(e-this.Distance)/(this.maxDistance-this.refDistance);case"inverse":return this.refDistance/(this.refDistance+this.rolloffFactor*(e-this.refDistance));case"exponential":return Math.pow(e/this.refDistance,-this.rolloffFactor);default:return 0}}},HOBA.ConeModel=function(){this.innerAngle=360,this.outerAngle=360,this.outerGain=0},HOBA.ConeModel.prototype={gain:function(t,e){if(0==e.x&&0==e.y&&0==e.z)return 1;if(360==this.innerAngle&&360==this.outerAngle)return 1;var n=new THREE.Vector3(t.x,t.y,t.z),i=new THREE.Vector3;i.subVectors(HOBA.listener.position,n),i.normalize();var r=new THREE.Vector3(e.x,e.y,e.z);r.normalize();var o,s=i.dot(r),a=180*Math.acos(s)/Math.PI,h=Math.abs(a),c=Math.abs(this.innerAngle)/2,u=Math.abs(this.outerAngle)/2;if(c>=h)o=1;else if(h>=u)o=this.outerGain;else{var l=(h-c)/(u-c);o=1-l+this.outerGain*l}return o}},HOBA=window.HOBA||{},HOBA.WAVH=function(){var t,e=this;this.format={},this.hrirs=[];var n=null;this.hrirLength=0,this.load=function(t){return new Promise(function(n,r){var o=new XMLHttpRequest;o.responseType="arraybuffer",o.onload=function(){e.hrirLength=0;var t=new DataView(o.response);i(t)?n(e):r()},o.open("get",t,!0),o.send(null)})};var i=function(e){if(n=e,!r())return!1;for(var i=!1,h=!1,c=12;t>c;){var u=o(c);c+=8,"fmt "==u.id?h=s(c):"LIST"==u.id&&(i=a(c,u.length)),c+=u.length}return h&&i},r=function(){return"RIFF"!=h(0,4)?!1:"WAVE"!=h(8,4)?!1:(t=n.getUint32(4,!0)+8,!0)},o=function(t){var e=h(t,4),i=n.getUint32(t+4,!0);return{id:e,length:i}},s=function(t){var i={};return i.sampleFormat=n.getUint16(t,!0),i.numChannels=n.getUint16(t+2,!0),i.sampleRate=n.getUint32(t+4,!0),i.byteRate=n.getUint32(t+8,!0),i.blockAlign=n.getUint16(t+12,!0),i.bitsPerSample=n.getUint16(t+14,!0),e.format=i,!0},a=function(t,i){var r=o(t);if("HRIR"==r.id){for(t+=4,e.minElevation=1e3,e.maxElevation=-1e3;i>t;){if(r=o(t),"info"==r.id){t+=8;var s={},a={},h=n.getFloat32(t,!0),c=n.getFloat32(t+4,!0),u=n.getFloat32(t+8,!0);if(s.delay=n.getFloat32(t+12,!0),a.delay=n.getFloat32(t+16,!0),c>e.maxElevation&&(e.maxElevation=c),c<e.minElevation&&(e.minElevation=c),t+=20,r=o(t),"data"==r.id&&(t+=8,i-(t+r.length)>=0)){if(16==e.format.bitsPerSample){var l=new Int16Array(n.buffer,t,r.length/2),f=HOBA.WAVH.toFloat(2,l,3051757813e-14);s.ir=f[0],a.ir=f[1],s.ir.length>e.hrirLength&&(e.hrirLength=s.ir.length),a.ir.length>e.hrirLength&&(e.hrirLength=a.ir.length)}else if(32==e.format.bitsPerSample&&3==e.format.sampleFormat){var l=new Float32Array(n.buffer,t,r.length/4);s.ir=l.subarray(0,l.length/2),a.ir=l.subarray(l.length/2),s.ir.length>e.hrirLength&&(e.hrirLength=s.ir.length),a.ir.length>e.hrirLength&&(e.hrirLength=a.ir.length)}e.hrirs.push({left:s,right:a,azimuth:h,elevation:c,distance:u})}}t+=r.length}return!0}return!1},h=function(t,e){for(var i="",r=0;e>r;r++)i+=String.fromCharCode(n.getUint8(t+r));return i};this.getMeasurementGrid2D=function(){for(var t=[],e=(2*Math.PI,0);e<this.hrirs.length;e++){var n=this.hrirs[e],i=n.elevation,r=n.azimuth;0>r&&(r+=360),t.push([i,r])}return t},this.getMeasurementGrid3D=function(){for(var t=[],e=2*Math.PI,n=0;n<this.hrirs.length;n++){var i=this.hrirs[n],r=1,o=i.elevation/360*e,s=i.azimuth/360*e,a=-r*Math.cos(o)*Math.cos(s),h=r*Math.cos(o)*Math.sin(s),c=r*Math.sin(o);t.push([h,c,a])}return t}},HOBA.WAVH.toFloat=function(t,e,n){console.assert(2==t);var i=e.length;void 0==n&&(n=1);for(var r=new Float32Array(i/2),o=new Float32Array(i/2),s=0,a=i/2,h=0;a>h;h++)r[s]=e[h]*n,o[s]=e[h+a]*n,s++;return[r,o]},HOBA=window.HOBA||{},HOBA.AudioListener=function(){var t=new THREE.Vector3(0,0,0),e=new THREE.Vector3(0,0,-1),n=new THREE.Vector3(0,1,0);Object.defineProperty(this,"position",{get:function(){return t},set:function(e){t.set(e[0],e[1],e[2]),HOBA._updateSources()}}),Object.defineProperty(this,"front",{get:function(){return e},set:function(t){e.set(t[0],t[1],t[2]),HOBA._updateSources()}}),Object.defineProperty(this,"up",{get:function(){return n},set:function(t){n.set(t[0],t[1],t[2]),HOBA._updateSources()}}),this.cartesian2spherical=function(i,r,o){var s={a:0,e:0,r:0},a=new THREE.Vector3(i,r,o),h=new THREE.Vector3;if(h.subVectors(a,t),s.r=h.length(),0==s.r)return s;h.normalize();var c=new THREE.Vector3;c.copy(e),c.cross(n),c.normalize();var u=new THREE.Vector3;u.copy(e),u.normalize();var l=new THREE.Vector3;l.crossVectors(c,u);var f=h.dot(l),p=new THREE.Vector3,g=new THREE.Vector3(l.x,l.y,l.z);g.multiplyScalar(f),p.subVectors(h,g),p.normalize(),s.a=180*Math.acos(p.dot(c))/Math.PI;var _=p.dot(e);return 0>_&&(s.a=360-s.a),s.a=s.a>=0&&s.a<=270?90-s.a:450-s.a,s.e=90-180*Math.acos(h.dot(l))/Math.PI,s.e>90?s.e=180-s.e:s.e<-90&&(s.e=-180-s.e),s},this.spherical2cartesian=function(t,e,n){0>t&&(t+=360);var i=Math.PI*(t/180),r=Math.PI*(e/180),o={};return o.x=n*Math.cos(r)*Math.sin(i),o.y=n*Math.sin(r),o.z=-n*Math.cos(r)*Math.cos(i),o}},HOBA.listener=new HOBA.AudioListener,HOBA=window.HOBA||{},HOBA.SpatialPanner=function(t){function e(){t||(t=HOBA.audioContext),s.actx=t,s.input=t.createGain(),s.output=t.createGain(),n=t.createConvolver(),i=t.createConvolver(),n.normalize=!1,i.normalize=!1,r=t.createGain(),o=t.createGain(),s.input.connect(n),s.input.connect(i),n.connect(r),i.connect(o),r.connect(s.output),o.connect(s.output),s._convolver1=n,s._convolver2=i,s._gain1=r,s._gain2=o,s._gain2.gain.value=0}var n,i,r,o,s=this;this._spos={a:0,e:0,r:0},this._srcgain=1,this._index=0,this._crossfaded=!0,this._pending=null,this.xfadeduration=.05,HOBA.PannerBase.call(this),e(),this.updateHRTF=function(){this._wavh&&(this._hrirL=new Float32Array(this._wavh.hrirLength),this._hrirR=new Float32Array(this._wavh.hrirLength),this._update("hrtf"))}},HOBA.SpatialPanner.prototype=Object.create(HOBA.PannerBase.prototype),Object.defineProperties(HOBA.SpatialPanner.prototype,{positionA:{get:function(){return this._spos.a},set:function(t){this._setPosS("a",t)}},positionE:{get:function(){return this._spos.e},set:function(t){this._setPosS("e",t)}},positionR:{get:function(){return this._spos.r},set:function(t){this._setPosS("r",t)}},elevationRange:{get:function(){return{min:this._wavh.minElevation,max:this._wavh.maxElevation}}}}),HOBA.SpatialPanner.prototype._setPosS=function(t,e){this._spos[t]=parseFloat(e),this.setSPosition(this._spos.a,this._spos.e,this._spos.r,!0)},HOBA.SpatialPanner.prototype._wavh=null,HOBA.SpatialPanner.prototype._geo=null,HOBA.SpatialPanner.prototype.loadHRTF=function(t){var e=this,n=HOBA.SpatialPanner.prototype;return new Promise(function(i,r){n._wavh=new HOBA.WAVH,n._wavh.load(t).then(function(){n._geo={},n._geo.points2D=n._wavh.getMeasurementGrid2D(),n._geo.points3D=n._wavh.getMeasurementGrid3D(),n._geo.triangles=Delaunay.triangulate(n._geo.points2D),e.updateHRTF(),i(n._geo)},function(){r()})})},HOBA.SpatialPanner.prototype.setSPosition=function(t,e,n,i){n=n||1,this._spos={a:t,e:e,r:n},i&&(this.posc=HOBA.listener.spherical2cartesian(t,e,n)),0>t&&(t+=360);var r=this._interpolate(t,e);if(r>=0?this._index=r:r=this._index,r>=0&&this._crossfaded){this._crossfaded=!1;var o=this.actx,s=o.createBuffer(2,this._wavh.hrirLength,o.sampleRate);if(s.copyToChannel)s.copyToChannel(this._hrirL,0),s.copyToChannel(this._hrirR,1);else for(var a=0;1>=a;a++)for(var h=0==a?this._hrirL:this._hrirR,c=s.getChannelData(a),u=0;u<h.length;u++)c[u]=h[u];this._convolver2.buffer=s;var l=this._distance.gain(n),f=this._cone.gain(this.posc,this.orientc),p=l*f*this._srcgain;this._gain2.gain.setValueAtTime(0,o.currentTime),this._gain2.gain.linearRampToValueAtTime(p,o.currentTime+this.xfadeduration),this._gain1.gain.setValueAtTime(p,o.currentTime),this._gain1.gain.linearRampToValueAtTime(0,o.currentTime+this.xfadeduration);var g=this;setTimeout(function(){if(g._crossfaded=!0,g._pending){var t=g._pending.a,e=g._pending.e,n=g._pending.r;g._pending=null,g.setSPosition(t,e,n)}},1e3*this.xfadeduration);var _=this._convolver1;this._convolver1=this._convolver2,this._convolver2=_;var p=this._gain1;this._gain1=this._gain2,this._gain2=p}else this._crossfaded||(this._pending={a:this._spos.a,e:e,r:n});return r},HOBA.SpatialPanner.prototype._update=function(t){if("position"==t){var e=this.posc.x,n=this.posc.y,i=this.posc.z,r=HOBA.listener.cartesian2spherical(e,n,i);return this.setSPosition(r.a,r.e,r.r)}this.setSPosition(this._spos.a,this._spos.e,this._spos.r)},HOBA.SpatialPanner.prototype._interpolate=function(t,e){for(var n,i,r,o,s,a,h,c,u,l,f,p=this._geo.triangles,g=this._geo.points2D,_=0;;){for(n=g[p[_]],_++,i=g[p[_]],_++,r=g[p[_]],_++,s=[n[0]-r[0],n[1]-r[1],i[0]-r[0],i[1]-r[1]],a=[s[3],-s[1],-s[2],s[0]],h=1/(s[0]*s[3]-s[1]*s[2]),c=0;c<a.length;++c)a[c]*=h;if(o=[e-r[0],t-r[1]],u=a[0]*o[0]+a[2]*o[1],l=a[1]*o[0]+a[3]*o[1],f=1-u-l,u>=0&&l>=0&&f>=0){for(var d=_-3,v=this._wavh.hrirs[p[d]],A=this._wavh.hrirs[p[d+1]],m=this._wavh.hrirs[p[d+2]],H=new Float32Array(this._wavh.hrirLength),O=new Float32Array(this._wavh.hrirLength),y=0;y<H.length;y++)H[y]=u*v.left.ir[y]+l*A.left.ir[y]+f*m.left.ir[y],O[y]=u*v.right.ir[y]+l*A.right.ir[y]+f*m.right.ir[y];return this._hrirL=H,this._hrirR=O,d}if(_>=p.length)break}return-1};
//# sourceMappingURL=hoba-spatialpanner-api.min.js.map